'use client'

import { useState, useEffect } from 'react'
import { useSession } from 'next-auth/react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'

interface ExamQuestion {
  text: string
  options: string[]
}

interface ExamData {
  id: string
  title: string
  description: string
  testQuestions: ExamQuestion[]
  practicalCase: {
    statement: string
    questions: ExamQuestion[]
  }
  hasCompleted: boolean
  previousAttempt?: {
    totalScore: number
    completedAt: string
  }
}

interface ExamResults {
  test: {
    correct: number
    incorrect: number
    blank: number
    rawScore: number
    score: number
    results: Array<{
      questionIndex: number
      userAnswer: string
      correctAnswer: string
      isCorrect: boolean
      isBlank: boolean
      explanation: string
    }>
  }
  practical: {
    correct: number
    incorrect: number
    blank: number
    rawScore: number
    score: number
    results: Array<{
      questionIndex: number
      userAnswer: string
      correctAnswer: string
      isCorrect: boolean
      isBlank: boolean
      explanation: string
    }>
  }
  totalScore: number
  rank: number
  timeSpent: number
}

export default function ExamModePage() {
  const { data: session, status } = useSession()
  const router = useRouter()
  const [exam, setExam] = useState<ExamData | null>(null)
  const [loading, setLoading] = useState(true)
  const [loadError, setLoadError] = useState<string>('')
  const [started, setStarted] = useState(false)
  const [part, setPart] = useState<1 | 2>(1) // 1 = Test, 2 = Supuesto
  const [currentIndex, setCurrentIndex] = useState(0)
  const [testAnswers, setTestAnswers] = useState<string[]>(Array(70).fill(''))
  const [practicalAnswers, setPracticalAnswers] = useState<string[]>(Array(15).fill(''))
  const [timeLeft, setTimeLeft] = useState(120 * 60) // 120 minutos
  const [startTime, setStartTime] = useState<number>(0)
  const [finished, setFinished] = useState(false)
  const [results, setResults] = useState<ExamResults | null>(null)
  const [submitting, setSubmitting] = useState(false)

  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/login')
    } else if (status === 'authenticated' && !started && !exam) {
      fetchExam()
    }
  }, [status, router, started, exam])

  useEffect(() => {
    let timer: NodeJS.Timeout
    if (started && !finished && timeLeft > 0) {
      timer = setInterval(() => {
        setTimeLeft(prev => {
          if (prev <= 1) {
            submitExam()
            return 0
          }
          return prev - 1
        })
      }, 1000)
    }
    return () => clearInterval(timer)
  }, [started, finished, timeLeft])

  const fetchExam = async () => {
    try {
      setLoadError('')
      const res = await fetch('/api/exam-official')
      if (!res.ok) {
        const data = await res.json()
        setLoadError(data.error || 'No se pudo cargar el examen oficial.')
        return
      }
      const data = await res.json()
      setExam(data)
    } catch (err) {
      console.error(err)
      setLoadError('Error de conexi√≥n al cargar el examen.')
    } finally {
      setLoading(false)
    }
  }

  const startExam = () => {
    if (!exam) {
      alert(loadError || 'No hay examen disponible.')
      return
    }
    setStarted(true)
    setStartTime(Date.now())
    setTimeLeft(120 * 60)
    setPart(1)
    setCurrentIndex(0)
    setTestAnswers(Array(70).fill(''))
    setPracticalAnswers(Array(15).fill(''))
    setFinished(false)
    setResults(null)
  }

  const handleAnswer = (answer: string) => {
    if (part === 1) {
      const newAnswers = [...testAnswers]
      newAnswers[currentIndex] = answer
      setTestAnswers(newAnswers)
    } else {
      const newAnswers = [...practicalAnswers]
      newAnswers[currentIndex] = answer
      setPracticalAnswers(newAnswers)
    }
  }

  const nextQuestion = () => {
    if (part === 1 && currentIndex < 69) {
      setCurrentIndex(currentIndex + 1)
    } else if (part === 1 && currentIndex === 69) {
      // Pasar a la parte 2
      setPart(2)
      setCurrentIndex(0)
    } else if (part === 2 && currentIndex < 14) {
      setCurrentIndex(currentIndex + 1)
    }
  }

  const submitExam = async () => {
    if (submitting || !exam) return
    
    setSubmitting(true)
    const timeSpent = Math.floor((Date.now() - startTime) / 1000)

    try {
      const res = await fetch('/api/exam-official/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          examId: exam.id,
          testAnswers,
          practicalAnswers,
          timeSpent
        })
      })

      if (!res.ok) {
        throw new Error('Error al enviar el examen')
      }

      const data = await res.json()
      setResults(data.attempt)
      setFinished(true)
    } catch (error) {
      console.error('[Submit exam]', error)
      alert('Hubo un error al enviar el examen. Por favor, int√©ntalo de nuevo.')
    } finally {
      setSubmitting(false)
    }
  }

  const formatTime = (seconds: number) => {
    const hrs = Math.floor(seconds / 3600)
    const mins = Math.floor((seconds % 3600) / 60)
    const secs = seconds % 60
    return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
  }

  if (loading) {
    return <div className="min-h-screen bg-gradient-to-br from-orange-50 to-red-100 flex items-center justify-center">
      <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-orange-600"></div>
    </div>
  }

  if (!started && !finished) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-red-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-12 max-w-2xl w-full">
          <div className="text-6xl text-center mb-6">üìù</div>
          <h1 className="text-4xl font-bold text-center text-gray-800 mb-4">
            Examen Oficial
          </h1>
          
          {exam?.hasCompleted && exam.previousAttempt && (
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
              <p className="text-blue-800 font-semibold">‚úÖ Ya has completado este examen</p>
              <p className="text-blue-700 text-sm mt-1">
                Puntuaci√≥n anterior: <span className="font-bold">{exam.previousAttempt.totalScore.toFixed(2)}/100</span>
              </p>
              <p className="text-blue-600 text-xs mt-1">
                Puedes repetirlo, pero solo tu mejor puntuaci√≥n contar√° en el ranking.
              </p>
            </div>
          )}

          <div className="space-y-4 mb-8">
            <div className="bg-orange-50 p-4 rounded-lg">
              <h3 className="font-bold text-orange-900 mb-2">üìã Estructura del examen:</h3>
              <ul className="text-orange-800 space-y-1 text-sm">
                <li><strong>Parte 1:</strong> 70 preguntas tipo test</li>
                <li><strong>Parte 2:</strong> Supuesto pr√°ctico + 15 preguntas</li>
                <li><strong>Tiempo l√≠mite:</strong> 120 minutos</li>
                <li><strong>Puntuaci√≥n:</strong> Cada parte sobre 50 puntos</li>
              </ul>
            </div>
            <div className="bg-yellow-50 p-4 rounded-lg">
              <h3 className="font-bold text-yellow-900 mb-2">‚öñÔ∏è Sistema de puntuaci√≥n:</h3>
              <ul className="text-yellow-800 space-y-1 text-sm">
                <li>‚úÖ Respuesta correcta: <strong>+1 punto</strong></li>
                <li>‚ùå Respuesta incorrecta: <strong>-0.25 puntos</strong></li>
                <li>‚ö™ En blanco: <strong>0 puntos</strong></li>
              </ul>
            </div>
            <div className="bg-red-50 p-4 rounded-lg">
              <h3 className="font-bold text-red-900 mb-2">‚ö†Ô∏è Condiciones:</h3>
              <ul className="text-red-800 space-y-1 text-sm">
                <li>‚Ä¢ No se puede volver a preguntas anteriores</li>
                <li>‚Ä¢ El tiempo se detiene solo al finalizar</li>
                <li>‚Ä¢ Tu puntuaci√≥n entrar√° en el ranking global</li>
              </ul>
            </div>
          </div>
          
          <div className="flex gap-4">
            <Link 
              href="/dashboard" 
              className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-4 rounded-lg text-center transition-all"
            >
              Cancelar
            </Link>
            <button
              onClick={startExam}
              disabled={loading || !!loadError || !exam}
              className={`flex-1 font-bold py-4 rounded-lg transition-all ${
                loading || !!loadError || !exam
                  ? 'bg-gray-200 text-gray-500 cursor-not-allowed'
                  : 'bg-gradient-to-r from-orange-600 to-red-600 text-white hover:shadow-lg'
              }`}
            >
              Comenzar Examen
            </button>
          </div>

          {loadError && (
            <div className="mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
              {loadError}
            </div>
          )}
        </div>
      </div>
    )
  }

  if (finished && results) {
    const passed = results.totalScore >= 50

    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-red-100 p-4">
        <div className="max-w-5xl mx-auto">
          <div className="bg-white rounded-2xl shadow-2xl p-8 mb-6">
            <div className="text-8xl text-center mb-6">{passed ? 'üéâ' : 'üòî'}</div>
            <h1 className="text-4xl font-bold text-center text-gray-800 mb-4">
              {passed ? '¬°Examen Completado!' : 'Examen Completado'}
            </h1>
            
            <div className="text-center mb-8">
              <div className="text-6xl font-bold text-gray-800 mb-2">
                {results.totalScore.toFixed(2)}/100
              </div>
              <p className="text-xl text-gray-600 mb-2">Puntuaci√≥n Total</p>
              <p className="text-lg text-orange-600 font-semibold">
                üèÜ Posici√≥n en ranking: #{results.rank}
              </p>
            </div>

            {/* Estad√≠sticas Parte 1: Test */}
            <div className="bg-blue-50 p-6 rounded-lg mb-6">
              <h3 className="font-bold text-blue-900 mb-4 text-xl">
                üìù Parte 1: Test (70 preguntas)
              </h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div className="text-center">
                  <div className="text-3xl font-bold text-green-600">{results.test.correct}</div>
                  <div className="text-sm text-gray-600">Correctas</div>
                </div>
                <div className="text-center">
                  <div className="text-3xl font-bold text-red-600">{results.test.incorrect}</div>
                  <div className="text-sm text-gray-600">Incorrectas</div>
                </div>
                <div className="text-center">
                  <div className="text-3xl font-bold text-gray-600">{results.test.blank}</div>
                  <div className="text-sm text-gray-600">En blanco</div>
                </div>
                <div className="text-center">
                  <div className="text-3xl font-bold text-blue-600">{results.test.score.toFixed(2)}</div>
                  <div className="text-sm text-gray-600">Puntos /50</div>
                </div>
              </div>
              <p className="text-sm text-blue-700">
                Puntuaci√≥n bruta: {results.test.rawScore.toFixed(2)} 
                ({results.test.correct} - {results.test.incorrect} √ó 0.25)
              </p>
            </div>

            {/* Estad√≠sticas Parte 2: Supuesto Pr√°ctico */}
            <div className="bg-purple-50 p-6 rounded-lg mb-6">
              <h3 className="font-bold text-purple-900 mb-4 text-xl">
                üìã Parte 2: Supuesto Pr√°ctico (15 preguntas)
              </h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div className="text-center">
                  <div className="text-3xl font-bold text-green-600">{results.practical.correct}</div>
                  <div className="text-sm text-gray-600">Correctas</div>
                </div>
                <div className="text-center">
                  <div className="text-3xl font-bold text-red-600">{results.practical.incorrect}</div>
                  <div className="text-sm text-gray-600">Incorrectas</div>
                </div>
                <div className="text-center">
                  <div className="text-3xl font-bold text-gray-600">{results.practical.blank}</div>
                  <div className="text-sm text-gray-600">En blanco</div>
                </div>
                <div className="text-center">
                  <div className="text-3xl font-bold text-purple-600">{results.practical.score.toFixed(2)}</div>
                  <div className="text-sm text-gray-600">Puntos /50</div>
                </div>
              </div>
              <p className="text-sm text-purple-700">
                Puntuaci√≥n bruta: {results.practical.rawScore.toFixed(2)} 
                ({results.practical.correct} - {results.practical.incorrect} √ó 0.25)
              </p>
            </div>

            <div className="flex gap-4">
              <Link 
                href="/dashboard" 
                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-4 rounded-lg text-center transition-all"
              >
                Volver al Dashboard
              </Link>
              <Link
                href="/exam-mode/ranking"
                className="flex-1 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold py-4 rounded-lg text-center hover:shadow-lg transition-all"
              >
                Ver Ranking Completo üèÜ
              </Link>
            </div>
          </div>

          {/* Detalles de respuestas */}
          <div className="bg-white rounded-2xl shadow-lg p-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">Revisi√≥n de Respuestas</h2>
            
            <div className="mb-8">
              <h3 className="text-xl font-bold text-blue-800 mb-4">Parte 1: Test</h3>
              <div className="space-y-3">
                {results.test.results.slice(0, 10).map((r, i) => (
                  <div key={i} className={`p-4 rounded-lg border-2 ${
                    r.isBlank ? 'bg-gray-50 border-gray-300' :
                    r.isCorrect ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'
                  }`}>
                    <div className="flex items-start justify-between">
                      <span className="font-semibold text-gray-700">Pregunta {i + 1}</span>
                      <span className={`text-sm font-bold ${
                        r.isBlank ? 'text-gray-600' :
                        r.isCorrect ? 'text-green-600' : 'text-red-600'
                      }`}>
                        {r.isBlank ? 'En blanco' : r.isCorrect ? '‚úì Correcta' : '‚úó Incorrecta'}
                      </span>
                    </div>
                    <p className="text-sm text-gray-600 mt-1">
                      Tu respuesta: <strong>{r.userAnswer || '-'}</strong> | 
                      Correcta: <strong>{r.correctAnswer}</strong>
                    </p>
                  </div>
                ))}
                {results.test.results.length > 10 && (
                  <p className="text-sm text-gray-500 text-center">
                    ... y {results.test.results.length - 10} preguntas m√°s
                  </p>
                )}
              </div>
            </div>

            <div>
              <h3 className="text-xl font-bold text-purple-800 mb-4">Parte 2: Supuesto Pr√°ctico</h3>
              <div className="space-y-3">
                {results.practical.results.map((r, i) => (
                  <div key={i} className={`p-4 rounded-lg border-2 ${
                    r.isBlank ? 'bg-gray-50 border-gray-300' :
                    r.isCorrect ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'
                  }`}>
                    <div className="flex items-start justify-between">
                      <span className="font-semibold text-gray-700">Pregunta {i + 1}</span>
                      <span className={`text-sm font-bold ${
                        r.isBlank ? 'text-gray-600' :
                        r.isCorrect ? 'text-green-600' : 'text-red-600'
                      }`}>
                        {r.isBlank ? 'En blanco' : r.isCorrect ? '‚úì Correcta' : '‚úó Incorrecta'}
                      </span>
                    </div>
                    <p className="text-sm text-gray-600 mt-1">
                      Tu respuesta: <strong>{r.userAnswer || '-'}</strong> | 
                      Correcta: <strong>{r.correctAnswer}</strong>
                    </p>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>
    )
  }
          <h1 className="text-4xl font-bold text-center text-gray-800 mb-4">
            {passed ? '¬°Aprobado!' : 'No aprobado'}
          </h1>
          <div className="text-center mb-8">
            <div className="text-6xl font-bold text-gray-800 mb-2">{percentage}%</div>
            <p className="text-xl text-gray-600">
              {score} de {questions.length} correctas
            </p>
          </div>
          <div className="bg-gray-50 p-6 rounded-lg mb-8">
            <h3 className="font-bold text-gray-800 mb-4">üìä Desglose:</h3>
            <div className="space-y-2">
              <div className="flex justify-between">
                <span className="text-gray-600">Correctas:</span>
                <span className="text-green-600 font-bold">{score}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">Incorrectas:</span>
                <span className="text-red-600 font-bold">{incorrectCount}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">En blanco:</span>
                <span className="text-gray-600 font-bold">{unansweredCount}</span>
              </div>
            </div>
          </div>
          <div className="flex gap-4">
            <Link 
              href="/dashboard" 
              className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-4 rounded-lg text-center transition-all"
            >
              Volver al Dashboard
            </Link>
            <button
              onClick={() => window.location.reload()}
              className="flex-1 bg-gradient-to-r from-orange-600 to-red-600 text-white font-bold py-4 rounded-lg hover:shadow-lg transition-all"
            >
              Repetir Examen
            </button>
          </div>
        </div>
      </div>
    )
  }

  const currentQuestion = questions[currentIndex]
  const progress = ((currentIndex + 1) / questions.length) * 100

  if (!currentQuestion) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-red-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-12 max-w-xl text-center">
          <h1 className="text-2xl font-bold text-gray-800 mb-2">No hay preguntas para mostrar</h1>
          <p className="text-gray-600 mb-6">Vuelve atr√°s e int√©ntalo de nuevo.</p>
          <div className="flex gap-4">
            <button
              onClick={() => {
                setStarted(false)
                setFinished(false)
                setCurrentIndex(0)
              }}
              className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg"
            >
              Volver
            </button>
            <Link
              href="/dashboard"
              className="flex-1 bg-gradient-to-r from-orange-600 to-red-600 text-white font-bold py-3 rounded-lg text-center"
            >
              Dashboard
            </Link>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-red-100 p-4">
      <div className="max-w-4xl mx-auto">
        {/* Header con tiempo y progreso */}
        <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
          <div className="flex items-center justify-between mb-2">
            <div>
              <span className="text-sm text-gray-600">Pregunta</span>
              <span className="ml-2 text-2xl font-bold text-gray-800">
                {currentIndex + 1} / {questions.length}
              </span>
            </div>
            <div className="text-right">
              <div className="text-sm text-gray-600">Tiempo restante</div>
              <div className={`text-2xl font-bold ${timeLeft < 600 ? 'text-red-600' : 'text-gray-800'}`}>
                {formatTime(timeLeft)}
              </div>
            </div>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div 
              className="bg-gradient-to-r from-orange-500 to-red-500 h-2 rounded-full transition-all"
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>

        {/* Pregunta */}
        <div className="bg-white rounded-xl shadow-lg p-8">
          {currentQuestion.temaTitulo && (
            <div className="bg-orange-50 px-4 py-2 rounded-lg mb-4 inline-block">
              <span className="text-sm text-orange-800">
                Tema {currentQuestion.temaNumero}: {currentQuestion.temaTitulo}
              </span>
            </div>
          )}

          <h2 className="text-2xl font-bold text-gray-800 mb-6">
            {currentQuestion.text}
          </h2>

          <div className="space-y-3 mb-6">
            {currentQuestion.options.map((option, i) => {
              const letter = ['A', 'B', 'C', 'D'][i]
              const isSelected = answers[currentIndex] === letter
              return (
                <button
                  key={i}
                  onClick={() => handleAnswer(letter)}
                  className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                    isSelected
                      ? 'bg-orange-100 border-orange-500'
                      : 'bg-gray-50 border-gray-200 hover:border-orange-300'
                  }`}
                >
                  <span className="font-semibold mr-3">{letter})</span>
                  {option}
                </button>
              )
            })}
          </div>

          <div className="flex gap-4">
            {currentIndex < questions.length - 1 ? (
              <button
                onClick={() => setCurrentIndex(currentIndex + 1)}
                disabled={!answers[currentIndex]}
                className={`flex-1 font-bold py-4 rounded-lg transition-all ${
                  answers[currentIndex]
                    ? 'bg-gradient-to-r from-orange-600 to-red-600 text-white hover:shadow-lg'
                    : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                }`}
              >
                Siguiente Pregunta ‚Üí
              </button>
            ) : (
              <button
                onClick={finishExam}
                className="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-4 rounded-lg hover:shadow-lg transition-all"
              >
                Finalizar Examen
              </button>
            )}
          </div>

          {!answers[currentIndex] && (
            <p className="text-center text-gray-500 text-sm mt-4">
              Selecciona una respuesta para continuar
            </p>
          )}
        </div>
      </div>
    </div>
  )
}
