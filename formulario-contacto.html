<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Formulario de Contacto (Email y Teléfono)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --radius: 0.9rem;
      --transition: 150ms ease-out;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.65);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top left, #1d4ed8 0, transparent 55%),
                  radial-gradient(circle at bottom right, #22c55e 0, transparent 55%),
                  radial-gradient(circle at top right, #e11d48 0, transparent 60%),
                  #020617;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 12px;
    }

    .app {
      width: 100%;
      max-width: 880px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.13) 0, transparent 50%),
                  radial-gradient(circle at bottom right, rgba(52, 211, 153, 0.14) 0, transparent 55%),
                  var(--card);
      border-radius: 1.5rem;
      border: 1px solid rgba(148, 163, 184, 0.24);
      box-shadow: var(--shadow-soft);
      padding: 26px 26px 22px;
      backdrop-filter: blur(20px);
    }

    @media (min-width: 768px) {
      .app {
        padding: 30px 34px 26px;
      }
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 18px;
    }

    .header-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    h1 {
      font-size: 1.5rem;
      letter-spacing: 0.02em;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #60a5fa, #22c55e);
      color: white;
      font-size: 0.9rem;
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }

    .pill {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.25) 0, transparent 55%),
                  rgba(15, 23, 42, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--muted);
      max-width: 620px;
      margin: 0;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap: 20px;
      margin-top: 12px;
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.72) 0, rgba(15, 23, 42, 0.88) 40%),
                  rgba(2, 6, 23, 0.98);
      border-radius: var(--radius);
      border: 1px solid rgba(30, 64, 175, 0.5);
      padding: 18px 16px 16px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      border: 1px solid rgba(56, 189, 248, 0.15);
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title-badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--muted);
    }

    .card-description {
      margin: 0 0 10px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    label {
      font-size: 0.8rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .label-main {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .label-main span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .hint {
      font-size: 0.72rem;
      color: var(--muted);
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"] {
      width: 100%;
      padding: 9px 10px;
      border-radius: 0.75rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9) 0, rgba(15, 23, 42, 0.98) 55%);
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      transition: border-color var(--transition), box-shadow var(--transition), background var(--transition), transform var(--transition);
    }

    input::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
      transform: translateY(-0.5px);
    }

    .row-two {
      display: grid;
      grid-template-columns: 1.2fr 0.9fr;
      gap: 10px;
    }

    @media (max-width: 640px) {
      .row-two {
        grid-template-columns: 1fr;
      }
    }

    .checkbox-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-top: 2px;
    }

    .checkbox-row input[type="checkbox"] {
      margin-top: 2px;
      accent-color: #22c55e;
    }

    .checkbox-row span {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }

    .primary-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 0.85rem;
      font-weight: 500;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      background: radial-gradient(circle at 20% 0%, #60a5fa 0, #2563eb 35%, #22c55e 100%);
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.4);
      transition: transform var(--transition), box-shadow var(--transition), filter var(--transition);
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.5);
      filter: brightness(1.05);
    }

    .primary-btn:active {
      transform: translateY(0px) scale(0.99);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.7);
    }

    .secondary-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 8px 12px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96) 0, rgba(15, 23, 42, 0.98) 55%);
      color: var(--muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background var(--transition), border-color var(--transition), color var(--transition), transform var(--transition);
      white-space: nowrap;
    }

    .secondary-btn:hover {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(248, 250, 252, 0.7);
      color: #e5e7eb;
      transform: translateY(-0.5px);
    }

    .secondary-btn:active {
      transform: translateY(0px) scale(0.99);
    }

    .status {
      margin-top: 6px;
      font-size: 0.75rem;
      min-height: 18px;
    }

    .status.success {
      color: #4ade80;
    }

    .status.error {
      color: var(--danger);
    }

    .status.muted {
      color: var(--muted);
    }

    .list-card {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9) 0, rgba(15, 23, 42, 0.98) 55%);
      border-radius: var(--radius);
      border: 1px solid rgba(31, 41, 55, 0.85);
      padding: 14px 14px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    .list-card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
      pointer-events: none;
    }

    .list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .list-title {
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      color: var(--muted);
      background: rgba(2, 6, 23, 0.9);
    }

    .list-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      font-size: 0.78rem;
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9) 0, rgba(15, 23, 42, 1) 55%);
    }

    thead {
      background: linear-gradient(to right, rgba(31, 41, 55, 0.98), rgba(17, 24, 39, 0.98));
    }

    th, td {
      padding: 7px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      white-space: nowrap;
    }

    th {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(148, 163, 184, 0.9);
    }

    td {
      font-size: 0.78rem;
      color: #e5e7eb;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.9);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.96);
    }

    tbody tr:hover {
      background: rgba(30, 64, 175, 0.35);
    }

    .empty-state {
      padding: 10px 8px;
      text-align: center;
      font-size: 0.76rem;
      color: var(--muted);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.68rem;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: rgba(148, 163, 184, 0.95);
    }

    .footer-note {
      margin-top: 6px;
      font-size: 0.7rem;
      color: rgba(148, 163, 184, 0.8);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .footer-note strong {
      color: rgba(226, 232, 240, 0.9);
      font-weight: 500;
    }

    .badge-soft {
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 0.68rem;
      background: rgba(56, 189, 248, 0.07);
      border: 1px solid rgba(56, 189, 248, 0.25);
      color: rgba(191, 219, 254, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .badge-soft span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #38bdf8;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="header-title-row">
        <h1>
          <span class="icon">✍️</span>
          Registro de emails y teléfonos
        </h1>
        <div class="pill">
          <span class="pill-dot"></span>
          Formulario independiente
        </div>
      </div>
      <p class="subtitle">
        Usa esta página para que cualquier persona pueda dejar su
        <strong>correo electrónico</strong> y <strong>número de teléfono</strong>.
        Los registros se guardan en esta misma pantalla y se pueden exportar.
      </p>
    </header>

    <div class="layout">
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            Nueva inscripción
            <span class="card-title-badge">Entrada individual</span>
          </div>
        </div>
        <p class="card-description">
          Rellena los datos de la persona. Puedes usar el mismo dispositivo
          para que se inscriban <strong>tantas personas como quieras</strong>.
        </p>

        <form id="contact-form" autocomplete="off">
          <div class="field-group">
            <label for="name">
              <span class="label-main"><span class="dot"></span>Nombre (opcional)</span>
            </label>
            <input
              id="name"
              name="name"
              type="text"
              placeholder="Ej. Ana García"
            />
          </div>

          <div class="field-group">
            <label for="email">
              <span class="label-main"><span class="dot"></span>Email</span>
              <span class="hint">Obligatorio</span>
            </label>
            <input
              id="email"
              name="email"
              type="email"
              required
              autocomplete="off"
              placeholder="nombre@ejemplo.com"
            />
          </div>

          <div class="row-two">
            <div class="field-group">
              <label for="phone">
                <span class="label-main"><span class="dot"></span>Teléfono</span>
                <span class="hint">Obligatorio</span>
              </label>
              <input
                id="phone"
                name="phone"
                type="tel"
                required
                autocomplete="off"
                placeholder="Ej. 600 123 456"
              />
            </div>
            <div class="field-group">
              <label for="note">
                <span class="label-main"><span class="dot"></span>Nota breve</span>
                <span class="hint">Opcional</span>
              </label>
              <input
                id="note"
                name="note"
                type="text"
                placeholder="Ej. Grupo mañana / Aula 3"
              />
            </div>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="consent" required />
            <span>
              Confirmo que la persona ha sido informada y consiente que se
              utilicen estos datos de contacto para el fin previsto.
            </span>
          </div>

          <div class="actions">
            <button type="submit" class="primary-btn">
              Guardar inscripción
            </button>
            <button type="button" id="clear-form" class="secondary-btn">
              Limpiar campos
            </button>
          </div>

          <div id="status" class="status muted">
            Completa los datos y pulsa «Guardar inscripción».
          </div>
        </form>
      </section>

      <section class="list-card">
        <div class="list-header">
          <div class="list-title">
            Listado de personas
            <span class="chip" id="count-chip">0 personas</span>
          </div>
          <div class="list-actions">
            <button type="button" id="export-csv" class="secondary-btn">
              Exportar CSV
            </button>
            <button type="button" id="clear-all" class="secondary-btn">
              Vaciar lista
            </button>
          </div>
        </div>

        <div style="max-height: 270px; overflow: auto; border-radius: 0.75rem;">
          <table id="data-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Nombre</th>
                <th>Email</th>
                <th>Teléfono</th>
                <th>Nota</th>
                <th>Fecha / Hora</th>
              </tr>
            </thead>
            <tbody id="table-body">
              <tr id="empty-row">
                <td colspan="6" class="empty-state">
                  Todavía no hay inscripciones. Se irán mostrando aquí una a
                  una cuando guardes cada formulario.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="footer-note">
          <span>
            <strong>Importante:</strong> estos datos se guardan <strong>solo en esta página</strong>
            (memoria local del navegador). Si cierras la ventana, se perderán.
          </span>
          <span class="badge-soft">
            <span class="dot"></span>
            Sugerencia: descarga el CSV con regularidad
          </span>
        </div>
      </section>
    </div>
  </div>

  <script>
    (function () {
      const form = document.getElementById('contact-form');
      const clearFormBtn = document.getElementById('clear-form');
      const statusEl = document.getElementById('status');
      const tableBody = document.getElementById('table-body');
      const emptyRow = document.getElementById('empty-row');
      const countChip = document.getElementById('count-chip');
      const exportBtn = document.getElementById('export-csv');
      const clearAllBtn = document.getElementById('clear-all');

      const entries = [];

      function setStatus(message, type) {
        statusEl.textContent = message;
        statusEl.className = 'status ' + (type || 'muted');
      }

      function validateEmail(email) {
        const re = /[^@\s]+@[^@\s]+\.[^@\s]+/;
        return re.test(String(email).toLowerCase());
      }

      function normalizePhone(phone) {
        return String(phone || '')
          .replace(/[^0-9+]/g, '')
          .trim();
      }

      function updateCount() {
        const count = entries.length;
        if (count === 0) {
          countChip.textContent = '0 personas';
        } else if (count === 1) {
          countChip.textContent = '1 persona';
        } else {
          countChip.textContent = count + ' personas';
        }
      }

      function renderTable() {
        while (tableBody.firstChild) {
          tableBody.removeChild(tableBody.firstChild);
        }

        if (entries.length === 0) {
          tableBody.appendChild(emptyRow);
          return;
        }

        entries.forEach((entry, idx) => {
          const tr = document.createElement('tr');

          const cIndex = document.createElement('td');
          cIndex.textContent = String(idx + 1).padStart(2, '0');
          cIndex.style.color = 'rgba(148,163,184,0.9)';

          const cName = document.createElement('td');
          cName.textContent = entry.name || '—';

          const cEmail = document.createElement('td');
          cEmail.textContent = entry.email;

          const cPhone = document.createElement('td');
          cPhone.textContent = entry.phone;

          const cNote = document.createElement('td');
          cNote.textContent = entry.note || '—';

          const cTime = document.createElement('td');
          cTime.textContent = entry.timestamp;

          tr.appendChild(cIndex);
          tr.appendChild(cName);
          tr.appendChild(cEmail);
          tr.appendChild(cPhone);
          tr.appendChild(cNote);
          tr.appendChild(cTime);

          tableBody.appendChild(tr);
        });
      }

      function addEntry(data) {
        entries.push(data);
        if (emptyRow.parentNode === tableBody) {
          tableBody.removeChild(emptyRow);
        }
        updateCount();
        renderTable();
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        const name = (document.getElementById('name').value || '').trim();
        const email = (document.getElementById('email').value || '').trim();
        const phoneRaw = (document.getElementById('phone').value || '').trim();
        const note = (document.getElementById('note').value || '').trim();
        const consent = document.getElementById('consent').checked;

        if (!email || !validateEmail(email)) {
          setStatus('Por favor, introduce un email válido.', 'error');
          return;
        }

        const phone = normalizePhone(phoneRaw);
        if (!phone) {
          setStatus('Por favor, introduce un número de teléfono.', 'error');
          return;
        }

        if (!consent) {
          setStatus('Debes marcar la casilla de consentimiento.', 'error');
          return;
        }

        const now = new Date();
        const timestamp = now.toLocaleString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        });
        
        // Enviar al backend para almacenamiento centralizado
        fetch('/api/contact-leads', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name,
            email,
            phone,
            note,
            source: 'whatsapp-form',
          }),
        })
          .then(async (res) => {
            if (!res.ok) {
              const data = await res.json().catch(() => null)
              const msg = data && data.error ? data.error : 'No se ha podido guardar en el servidor.'
              throw new Error(msg)
            }
            return res.json()
          })
          .then(() => {
            addEntry({ name, email, phone, note, timestamp })
            form.reset()
            setStatus('Inscripción guardada correctamente. Lista para la siguiente persona.', 'success')
            document.getElementById('name').focus()
          })
          .catch((err) => {
            console.error('Error al enviar al servidor', err)
            addEntry({ name, email, phone, note, timestamp })
            setStatus('Se ha guardado localmente, pero hubo un problema al guardar en el servidor.', 'error')
          })
      });

      clearFormBtn.addEventListener('click', function () {
        form.reset();
        setStatus('Campos limpiados. Puedes introducir una nueva persona.', 'muted');
        document.getElementById('name').focus();
      });

      clearAllBtn.addEventListener('click', function () {
        if (entries.length === 0) return;
        const confirmed = window.confirm('¿Seguro que quieres vaciar toda la lista? Esta acción no se puede deshacer.');
        if (!confirmed) return;
        entries.length = 0;
        updateCount();
        renderTable();
        setStatus('Lista vaciada. Puedes seguir registrando personas nuevas.', 'muted');
      });

      exportBtn.addEventListener('click', function () {
        if (entries.length === 0) {
          setStatus('No hay datos para exportar todavía.', 'error');
          return;
        }

        const headers = ['Nombre', 'Email', 'Telefono', 'Nota', 'FechaHora'];
        const rows = entries.map((e) => [e.name, e.email, e.phone, e.note, e.timestamp]);

        const csvLines = [
          headers.join(';'),
          ...rows.map((r) =>
            r
              .map((value) => {
                const v = value == null ? '' : String(value);
                if (v.includes(';') || v.includes('"') || v.includes('\n')) {
                  return '"' + v.replace(/"/g, '""') + '"';
                }
                return v;
              })
              .join(';')
          ),
        ];

        const blob = new Blob([csvLines.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const date = new Date();
        const stamp =
          date.getFullYear().toString() +
          String(date.getMonth() + 1).padStart(2, '0') +
          String(date.getDate()).padStart(2, '0') +
          '-' +
          String(date.getHours()).padStart(2, '0') +
          String(date.getMinutes()).padStart(2, '0');

        a.href = url;
        a.download = 'contactos-' + stamp + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        setStatus('CSV descargado correctamente.', 'success');
      });

      updateCount();
      renderTable();
      setStatus('Completa los datos y pulsa «Guardar inscripción».', 'muted');
    })();
  </script>
</body>
</html>
